<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anaesthesia Suite Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { darkbg: '#0f172a', darkcard: '#1e293b' } } }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid #e2e8f0; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .dark .glass { background: rgba(30, 41, 59, 0.95); border-color: #334155; color: #e2e8f0; }
        
        input, select, textarea { border: 1px solid #cbd5e1; border-radius: 10px; padding: 12px; width: 100%; transition: 0.2s; font-size: 14px; background: white; color: #0f172a; }
        .dark input, .dark select, .dark textarea { background: #0f172a; border-color: #334155; color: white; }
        input:focus { border-color: #3b82f6; outline: none; ring: 2px solid rgba(59, 130, 246, 0.5); }
        
        label { font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 6px; display: block; letter-spacing: 0.8px; }
        .dark label { color: #94a3b8; }
        
        .view { display: none; opacity: 0; transform: translateY(10px); transition: opacity 0.3s, transform 0.3s; }
        .view.active { display: block; opacity: 1; transform: translateY(0); }
        
        .pill { cursor: pointer; padding: 8px 16px; border-radius: 99px; font-size: 11px; font-weight: 700; border: 1px solid #e2e8f0; background: white; transition: 0.2s; color: #64748b; }
        .dark .pill { background: #0f172a; border-color: #334155; color: #94a3b8; }
        .pill.active { background: #3b82f6; color: white; border-color: #3b82f6; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .dark .card-hover:hover { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5); }

        .bar-container { display: flex; align-items: flex-end; justify-content: space-around; height: 160px; padding-top: 20px; }
        .bar { width: 12%; background: linear-gradient(to top, #3b82f6, #60a5fa); border-radius: 6px 6px 0 0; position: relative; transition: height 1s cubic-bezier(0.4, 0, 0.2, 1); }
        .bar span { position: absolute; top: -22px; left: 50%; transform: translateX(-50%); font-size: 10px; font-weight: bold; color: #475569; }
        .dark .bar span { color: #cbd5e1; }
        .bar label { position: absolute; bottom: -28px; left: 50%; transform: translateX(-50%); font-size: 10px; width: 120%; text-align: center; color: #64748b; }

        #toast { visibility: hidden; min-width: 250px; background-color: #0f172a; color: #fff; text-align: center; border-radius: 12px; padding: 16px; position: fixed; z-index: 9999; left: 50%; bottom: 30px; transform: translateX(-50%); font-weight: 700; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        #toast.show { visibility: visible; animation: fadeinout 2.5s; }
        
        .wa-btn { background: #25D366; color: white; }
        .wa-btn:hover { background: #128C7E; }

        @keyframes fadeinout { 0% { bottom: 0; opacity: 0; } 20% { bottom: 30px; opacity: 1; } 80% { bottom: 30px; opacity: 1; } 100% { bottom: 0; opacity: 0; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 transition-colors duration-300" onload="initUI()">

<div id="toast">Action Confirmed</div>
<div id="qr_hidden" style="display:none"></div>

<div id="app" class="max-w-7xl mx-auto min-h-screen flex flex-col md:flex-row">
    
    <nav class="w-full md:w-72 bg-gradient-to-b from-slate-900 to-slate-950 text-white p-6 flex flex-col sticky top-0 md:h-screen z-[100] shadow-2xl">
        <div class="flex justify-between items-start mb-2 md:mb-10">
            <div>
                <h1 class="text-2xl md:text-3xl font-black tracking-tighter italic text-blue-400">ANAESPRO</h1>
                <p id="nav_dr_name" class="text-[10px] text-slate-400 font-bold mt-1 uppercase tracking-widest">Loading...</p>
            </div>
            <button onclick="toggleNav()" class="md:hidden p-2 text-slate-400 hover:text-white border border-slate-700 rounded-lg">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
        </div>

        <div id="nav_content" class="hidden md:flex flex-col flex-grow space-y-3">
            <button onclick="changeView('dashboard')" class="w-full text-left p-4 rounded-xl hover:bg-white/5 transition font-bold text-sm border border-transparent hover:border-slate-700/50 flex items-center gap-3"><span>üìä</span> Dashboard</button>
            <button onclick="changeView('new-case')" class="w-full text-left p-4 rounded-xl hover:bg-white/5 transition font-bold text-sm border border-transparent hover:border-slate-700/50 flex items-center gap-3"><span>‚úö</span> New Case</button>
            <button onclick="changeView('logbook')" class="w-full text-left p-4 rounded-xl hover:bg-white/5 transition font-bold text-sm border border-transparent hover:border-slate-700/50 flex items-center gap-3"><span>üìã</span> Logbook</button>
            <button onclick="toggleProfile()" class="w-full text-left p-4 rounded-xl border border-slate-700 hover:bg-white/5 transition font-bold text-sm mt-8 flex items-center gap-3"><span>‚öô</span> Settings & Data</button>
            
            <div class="pt-6 border-t border-slate-800 mt-auto space-y-3">
                <button onclick="toggleTheme()" class="w-full bg-slate-800 hover:bg-slate-700 p-3 rounded-xl text-xs font-bold flex items-center justify-center gap-2"><span id="theme_icon">üåë</span> Toggle OT Mode</button>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="exportFullSummary('print')" class="bg-blue-600 hover:bg-blue-500 p-3 rounded-xl text-[10px] font-black uppercase shadow-lg transition">Summary PDF</button>
                    <button onclick="exportFullSummary('whatsapp')" class="wa-btn p-3 rounded-xl text-[10px] font-black uppercase shadow-lg transition flex items-center justify-center gap-1">
                        <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24"><path d="M12.031 6.172c-3.181 0-5.767 2.586-5.768 5.766-.001 1.298.38 2.27 1.019 3.287l-.711 2.598 2.664-.698c.969.585 1.961.936 3.297.936h.001c3.181 0 5.768-2.586 5.768-5.767.001-3.181-2.587-5.767-5.768-5.767zm0 11.533h-.001c-1.127 0-1.954-.284-2.775-.765l-1.99.522.531-1.94c-.544-.877-.85-1.724-.849-2.79.001-3.182 2.587-5.768 5.768-5.768 3.182 0 5.769 2.587 5.769 5.768 0 3.182-2.587 5.768-5.77 5.768z"/></svg>
                        Share
                    </button>
                </div>
                <button onclick="exportToExcel()" class="w-full bg-emerald-600 hover:bg-emerald-500 p-3 rounded-xl text-xs font-black uppercase shadow-lg transition tracking-widest">Export Excel</button>
            </div>
        </div>
    </nav>

    <main class="flex-grow p-4 md:p-10 pb-24 bg-slate-50 dark:bg-darkbg relative z-10 transition-colors duration-300">
        
        <div id="view-dashboard" class="view active">
            <div class="mb-8">
                <h2 class="text-3xl font-black text-slate-900 dark:text-white tracking-tight">Practice Overview</h2>
                <p class="text-xs text-slate-500 dark:text-slate-400 font-bold uppercase tracking-widest mt-1">Real-time Financial Insights</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="glass card-hover p-6 rounded-2xl border-l-8 border-blue-500">
                    <p class="text-[10px] text-slate-400 font-bold uppercase">Total Revenue (All Time)</p>
                    <p id="dash_total" class="text-3xl font-black text-slate-800 dark:text-white">‚Çπ0</p>
                </div>
                <div class="glass card-hover p-6 rounded-2xl border-l-8 border-emerald-500">
                    <p class="text-[10px] text-slate-400 font-bold uppercase">Revenue This Month</p>
                    <p id="dash_month" class="text-3xl font-black text-slate-800 dark:text-white">‚Çπ0</p>
                </div>
                <div class="glass card-hover p-6 rounded-2xl border-l-8 border-purple-500">
                    <p class="text-[10px] text-slate-400 font-bold uppercase">Total Cases</p>
                    <p id="dash_cases" class="text-3xl font-black text-slate-800 dark:text-white">0</p>
                </div>
            </div>

            <div class="glass p-6 rounded-3xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-black text-slate-700 dark:text-slate-300 uppercase">Revenue Trend (6 Months)</h3>
                </div>
                <div id="chart_container" class="bar-container border-b border-slate-200 dark:border-slate-700"></div>
            </div>

            <div class="mt-8 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 p-4 rounded-xl hidden" id="backup_warning">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">‚ö†Ô∏è</span>
                    <div>
                        <h4 class="font-bold text-yellow-800 dark:text-yellow-500 text-sm">Data Backup Recommended</h4>
                        <p class="text-[10px] text-yellow-700 dark:text-yellow-600">It's been over 7 days since your last backup. Please download a backup now.</p>
                    </div>
                    <button onclick="toggleProfile()" class="ml-auto bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 px-3 py-1 rounded-lg text-xs font-bold">Backup</button>
                </div>
            </div>
        </div>

        <div id="profile_view" class="hidden mb-10 glass p-6 md:p-8 rounded-3xl shadow-xl border-2 border-blue-500/20">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black uppercase text-slate-800 dark:text-white">Settings & Data</h2>
                <button onclick="toggleProfile()" class="text-slate-400 text-2xl hover:text-red-500">&times;</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <label class="text-blue-600 dark:text-blue-400 font-black">Identity</label>
                    <div><label>Your Name</label><input type="text" id="cfg_name"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label>Qualification</label><input type="text" id="cfg_degree"></div>
                        <div><label>Reg Number</label><input type="text" id="cfg_reg"></div>
                    </div>
                    <div><label>Hospital Header</label><textarea id="cfg_hosp" rows="2"></textarea></div>
                    
                    <button onclick="saveProfile()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black text-sm uppercase hover:bg-blue-700 transition mt-2">Save Settings</button>
                </div>
                <div class="space-y-4 bg-slate-50 dark:bg-darkcard p-6 rounded-2xl">
                    <label class="text-red-600 font-black">Data Management</label>
                    <button onclick="backupData()" class="w-full bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 p-4 rounded-xl text-left hover:bg-slate-50 dark:hover:bg-slate-700 transition group">
                        <span class="block font-bold text-slate-700 dark:text-slate-200">Download Backup (JSON)</span>
                        <span class="text-[10px] text-slate-400">Save all your case data to a file</span>
                    </button>
                    
                    <div class="relative">
                         <input type="file" id="restore_file" class="hidden" onchange="restoreData(this)">
                         <button onclick="document.getElementById('restore_file').click()" class="w-full bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 p-4 rounded-xl text-left hover:bg-slate-50 dark:hover:bg-slate-700 transition group">
                            <span class="block font-bold text-slate-700 dark:text-slate-200">Restore Data</span>
                            <span class="text-[10px] text-slate-400">Import a previously saved JSON file</span>
                        </button>
                    </div>

                    <button onclick="if(confirm('Delete ALL data? This cannot be undone.')) { localStorage.removeItem('anaes_v5_db'); location.reload(); }" class="w-full bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 p-4 rounded-xl text-xs font-black uppercase hover:bg-red-100 transition">
                        Reset Application
                    </button>
                </div>
            </div>
        </div>

        <div id="view-new-case" class="view">
            <h2 class="text-3xl font-black text-slate-900 dark:text-white tracking-tight mb-6">New Case Entry</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass p-5 md:p-8 rounded-3xl space-y-4 md:space-y-5 shadow-sm">
                    <h3 class="text-xs font-black text-blue-600 dark:text-blue-400 border-b dark:border-slate-700 pb-2 uppercase tracking-widest">Patient Registry</h3>
                    <div><label>Patient Full Name</label><input type="text" id="in_name" class="font-bold text-lg"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label>Age</label><input type="number" id="in_age"></div>
                        <div><label>Sex</label><select id="in_sex"><option>Male</option><option>Female</option><option>Other</option></select></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label>IPD / Case No</label><input type="text" id="in_ipd"></div>
                        <div><label>Procedure Date</label><input type="date" id="in_date"></div>
                    </div>
                </div>

                <div class="glass p-5 md:p-8 rounded-3xl space-y-4 md:space-y-5 shadow-sm">
                    <h3 class="text-xs font-black text-blue-600 dark:text-blue-400 border-b dark:border-slate-700 pb-2 uppercase tracking-widest">Surgical Details</h3>
                    <div><label>Surgery Performed</label><input type="text" id="in_surgery" list="dl_surgery"></div>
                    <div><label>Lead Surgeon</label><input type="text" id="in_surgeon" list="dl_surgeon"></div>
                    <div><label>Anaesthesia Type</label><input type="text" id="in_ana" list="dl_ana"></div>
                    <div><label>Hospital / Facility</label><input type="text" id="in_hosp" list="dl_hosp"></div>
                </div>
            </div>

            <div class="mt-4 md:mt-8 glass p-6 md:p-10 rounded-[2rem] border-2 border-slate-900 dark:border-blue-500/50 shadow-2xl">
                <div class="text-center mb-6">
                    <label class="text-slate-400 font-bold mb-2">Professional Fees (INR)</label>
                    <div class="flex justify-center items-center gap-3">
                        <span class="text-3xl md:text-5xl font-light text-slate-300 dark:text-slate-600">‚Çπ</span>
                        <input type="number" id="in_fee" class="text-4xl md:text-6xl font-black text-center bg-transparent border-none w-64 focus:ring-0 p-0 text-slate-900 dark:text-white placeholder-slate-200" placeholder="0">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 max-w-lg mx-auto mb-8">
                     <div><label>Payment Mode</label><select id="in_mop"><option>Cash</option><option>UPI</option><option>Bank Transfer</option></select></div>
                     <div><label>UTR / Ref (Optional)</label><input type="text" id="in_utr" placeholder="Trans ID"></div>
                </div>

                <div class="flex justify-center gap-4">
                    <button onclick="commitCase()" class="bg-slate-900 dark:bg-blue-600 text-white px-10 py-4 rounded-2xl font-black uppercase tracking-widest shadow-xl hover:scale-105 transition">Save Case Record</button>
                    <button onclick="resetForm()" class="px-6 py-4 rounded-2xl font-bold text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition">Clear</button>
                </div>
            </div>
        </div>

        <div id="view-logbook" class="view">
            <div class="flex flex-col md:flex-row justify-between items-end mb-6 gap-4">
                <div>
                    <h2 class="text-3xl font-black text-slate-900 dark:text-white tracking-tight">Case Logbook</h2>
                    <p class="text-xs text-slate-500 dark:text-slate-400 font-bold uppercase tracking-widest mt-1">History & Records</p>
                </div>
                <div class="flex gap-2 bg-white dark:bg-slate-800 p-1 rounded-full border border-slate-200 dark:border-slate-700 shadow-sm">
                    <div class="pill active" data-f="all">ALL</div>
                    <div class="pill" data-f="month">THIS MONTH</div>
                    <div class="pill" data-f="pending">PENDING</div>
                </div>
            </div>

            <div class="flex gap-4 mb-6">
                <input type="text" id="search_bar" onkeyup="renderLog()" placeholder="Search patient, surgery or surgeon..." class="shadow-sm">
                <select id="filter_hosp" onchange="renderLog()" class="w-48 shadow-sm">
                    <option value="All">All Hospitals</option>
                </select>
            </div>

            <div class="glass rounded-3xl overflow-hidden shadow-lg min-h-[400px]">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-100 dark:bg-slate-800 text-xs uppercase tracking-wider text-slate-500 dark:text-slate-400">
                                <th class="p-4 font-black">Date</th>
                                <th class="p-4 font-black">Patient</th>
                                <th class="p-4 font-black">Surgery</th>
                                <th class="p-4 font-black">Hospital</th>
                                <th class="p-4 font-black text-right">Fees</th>
                                <th class="p-4 font-black text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="log_body" class="text-sm font-medium text-slate-700 dark:text-slate-200 divide-y divide-slate-100 dark:divide-slate-700"></tbody>
                    </table>
                </div>
                <div id="empty_msg" class="hidden p-12 text-center text-slate-400 font-bold uppercase tracking-widest text-xs">No records found matching criteria</div>
            </div>
        </div>
    </main>

    <datalist id="dl_surgery"></datalist>
    <datalist id="dl_surgeon"></datalist>
    <datalist id="dl_ana"></datalist>
    <datalist id="dl_hosp"></datalist>

</div>

<script>
    // --- DATABASE & STATE ---
    let db = JSON.parse(localStorage.getItem('anaes_v5_db')) || [];
    let profile = JSON.parse(localStorage.getItem('anaes_v5_prof')) || { name: 'Doctor', degree: 'MBBS, MD', reg: '12345', hosp: 'City Hospital', lastBackup: 0, theme: 'light' };
    let editId = null;
    let timeFilter = 'all';

    // --- INITIALIZATION ---
    function initUI() {
        if(profile.theme === 'dark') document.documentElement.classList.add('dark');
        updateThemeIcon();
        
        document.getElementById('cfg_name').value = profile.name;
        document.getElementById('cfg_degree').value = profile.degree;
        document.getElementById('cfg_reg').value = profile.reg;
        document.getElementById('cfg_hosp').value = profile.hosp;
        document.getElementById('nav_dr_name').innerText = `Dr. ${profile.name.toUpperCase()}`;

        document.getElementById('in_date').valueAsDate = new Date();
        
        updateDatalists();
        checkBackupHealth();
        updateDashboard();
        setupSmartFilters();

        // Bind filter pills
        document.querySelectorAll('.pill').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
                btn.classList.add('active');
                timeFilter = btn.dataset.f;
                renderLog();
            });
        });
    }

    // --- THEME ENGINE ---
    function toggleTheme() {
        const isDark = document.documentElement.classList.toggle('dark');
        profile.theme = isDark ? 'dark' : 'light';
        localStorage.setItem('anaes_v5_prof', JSON.stringify(profile));
        updateThemeIcon();
    }
    function updateThemeIcon() {
        document.getElementById('theme_icon').innerText = profile.theme === 'dark' ? '‚òÄ' : 'üåë';
    }

    // --- NAVIGATION ---
    function changeView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(`view-${viewId}`).classList.add('active');
        if(window.innerWidth < 768) document.getElementById('nav_content').classList.add('hidden');
        if(viewId === 'logbook') renderLog();
    }
    function toggleNav() {
        document.getElementById('nav_content').classList.toggle('hidden');
    }
    function toggleProfile() {
        const p = document.getElementById('profile_view');
        p.classList.toggle('hidden');
        if(!p.classList.contains('hidden')) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    // --- CORE LOGIC ---
    function saveProfile() {
        profile.name = document.getElementById('cfg_name').value;
        profile.degree = document.getElementById('cfg_degree').value;
        profile.reg = document.getElementById('cfg_reg').value;
        profile.hosp = document.getElementById('cfg_hosp').value;
        localStorage.setItem('anaes_v5_prof', JSON.stringify(profile));
        document.getElementById('nav_dr_name').innerText = `Dr. ${profile.name.toUpperCase()}`;
        toggleProfile();
        showToast("Settings Saved");
    }

    function commitCase() {
        const nameVal = document.getElementById('in_name').value;
        if (!nameVal) return alert("Patient Name is required");

        const data = {
            id: editId || Date.now(),
            name: nameVal.toUpperCase(),
            age: document.getElementById('in_age').value,
            sex: document.getElementById('in_sex').value,
            ipd: document.getElementById('in_ipd').value,
            date: document.getElementById('in_date').value,
            surgery: document.getElementById('in_surgery').value,
            surgeon: document.getElementById('in_surgeon').value.replace(/^Dr\.\s*/i, ""),
            ana: document.getElementById('in_ana').value,
            hosp: document.getElementById('in_hosp').value,
            fee: parseFloat(document.getElementById('in_fee').value || 0),
            mop: document.getElementById('in_mop').value,
            utr: document.getElementById('in_utr').value
        };

        if(editId) {
            const idx = db.findIndex(x => x.id === editId);
            db[idx] = data;
            editId = null;
        } else {
            db.push(data);
        }

        localStorage.setItem('anaes_v5_db', JSON.stringify(db));
        resetForm();
        updateDatalists();
        changeView('logbook');
        showToast("Record Committed");
    }

    function cloneCase(id) {
        const c = db.find(x => x.id === id);
        document.getElementById('in_name').value = "";
        document.getElementById('in_age').value = "";
        document.getElementById('in_ipd').value = "";
        document.getElementById('in_sex').value = c.sex;
        document.getElementById('in_date').valueAsDate = new Date();
        document.getElementById('in_surgery').value = c.surgery;
        document.getElementById('in_surgeon').value = c.surgeon;
        document.getElementById('in_ana').value = c.ana;
        document.getElementById('in_hosp').value = c.hosp;
        document.getElementById('in_fee').value = c.fee;
        document.getElementById('in_mop').value = 'Cash';
        
        editId = null;
        changeView('new-case');
        showToast("Details Copied");
    }

    function renderLog() {
        const query = document.getElementById('search_bar').value.toLowerCase();
        const fHosp = document.getElementById('filter_hosp').value;
        
        let filtered = db.sort((a,b) => new Date(b.date) - new Date(a.date));

        if(timeFilter === 'month') {
            const now = new Date();
            filtered = filtered.filter(c => {
                const d = new Date(c.date);
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            });
        }

        if(query) {
            filtered = filtered.filter(c => 
                c.name.toLowerCase().includes(query) || 
                c.surgery.toLowerCase().includes(query) ||
                c.surgeon.toLowerCase().includes(query)
            );
        }
        
        if(fHosp !== 'All') {
            filtered = filtered.filter(c => c.hosp === fHosp);
        }

        const tbody = document.getElementById('log_body');
        tbody.innerHTML = '';
        
        if(filtered.length === 0) {
            document.getElementById('empty_msg').classList.remove('hidden');
        } else {
            document.getElementById('empty_msg').classList.add('hidden');
            filtered.forEach(c => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 dark:hover:bg-slate-700/50 transition group";
                tr.innerHTML = `
                    <td class="p-4 whitespace-nowrap text-slate-500 dark:text-slate-400 font-mono text-xs">${c.date}</td>
                    <td class="p-4">
                        <div class="font-bold text-slate-800 dark:text-white uppercase">${c.name}</div>
                        <div class="text-xs text-slate-500">${c.age} / ${c.sex}</div>
                    </td>
                    <td class="p-4">
                        <div class="font-bold text-xs uppercase text-blue-600 dark:text-blue-400">${c.surgery}</div>
                        <div class="text-[10px] text-slate-400">Dr. ${c.surgeon}</div>
                    </td>
                    <td class="p-4 text-xs text-slate-500 hidden md:table-cell">${c.hosp}</td>
                    <td class="p-4 text-right font-mono font-bold text-slate-700 dark:text-slate-300">‚Çπ${c.fee}</td>
                    <td class="p-4 text-center">
                        <div class="flex justify-center gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition">
                            <button onclick="generateReceipt(${c.id})" class="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200" title="Receipt">üìÑ</button>
                            <button onclick="editCase(${c.id})" class="p-2 bg-yellow-100 text-yellow-600 rounded-lg hover:bg-yellow-200" title="Edit">‚úèÔ∏è</button>
                            <button onclick="cloneCase(${c.id})" class="p-2 bg-purple-100 text-purple-600 rounded-lg hover:bg-purple-200" title="Clone">üìë</button>
                            <button onclick="deleteCase(${c.id})" class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200" title="Delete">üóë</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    function deleteCase(id) {
        if(confirm("Permanently delete this record?")) {
            db = db.filter(x => x.id !== id);
            localStorage.setItem('anaes_v5_db', JSON.stringify(db));
            renderLog();
            updateDashboard();
        }
    }

    function editCase(id) {
        const c = db.find(x => x.id === id);
        editId = id;
        document.getElementById('in_name').value = c.name;
        document.getElementById('in_age').value = c.age;
        document.getElementById('in_sex').value = c.sex;
        document.getElementById('in_ipd').value = c.ipd;
        document.getElementById('in_date').value = c.date;
        document.getElementById('in_surgery').value = c.surgery;
        document.getElementById('in_surgeon').value = c.surgeon;
        document.getElementById('in_ana').value = c.ana;
        document.getElementById('in_hosp').value = c.hosp;
        document.getElementById('in_fee').value = c.fee;
        document.getElementById('in_mop').value = c.mop || 'Cash';
        document.getElementById('in_utr').value = c.utr || '';
        
        changeView('new-case');
    }

    function resetForm() {
        document.querySelectorAll('#view-new-case input:not([type="date"])').forEach(i => i.value = '');
        document.getElementById('in_mop').value = 'Cash';
    }

    function updateDatalists() {
        const fill = (id, key) => {
            const list = [...new Set(db.map(x => x[key]))].filter(x => x);
            document.getElementById(id).innerHTML = list.map(v => `<option value="${v}">`).join('');
        };
        fill('dl_surgery', 'surgery');
        fill('dl_surgeon', 'surgeon');
        fill('dl_ana', 'ana');
        fill('dl_hosp', 'hosp');
    }

    function updateDashboard() {
        const total = db.reduce((s,c) => s + c.fee, 0);
        document.getElementById('dash_total').innerText = '‚Çπ' + total.toLocaleString();
        document.getElementById('dash_cases').innerText = db.length;

        const now = new Date();
        const thisMonth = db.filter(c => {
            const d = new Date(c.date);
            return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
        }).reduce((s,c) => s + c.fee, 0);
        document.getElementById('dash_month').innerText = '‚Çπ' + thisMonth.toLocaleString();

        // Chart Data
        const months = [];
        for(let i=5; i>=0; i--) {
            const d = new Date();
            d.setMonth(d.getMonth() - i);
            months.push({ m: d.getMonth(), y: d.getFullYear(), name: d.toLocaleString('default',{month:'short'}), val: 0 });
        }

        db.forEach(c => {
            const d = new Date(c.date);
            const slot = months.find(m => m.m === d.getMonth() && m.y === d.getFullYear());
            if(slot) slot.val += c.fee;
        });

        const maxVal = Math.max(...months.map(m => m.val)) || 1;
        document.getElementById('chart_container').innerHTML = months.map(m => `
            <div class="bar" style="height: ${(m.val/maxVal)*100}%;">
                <span>‚Çπ${(m.val/1000).toFixed(1)}k</span>
                <label>${m.name}</label>
            </div>
        `).join('');
    }

    function setupSmartFilters() {
        const hosps = [...new Set(db.map(c => c.hosp))].filter(Boolean);
        document.getElementById('filter_hosp').innerHTML = `<option value="All">All Hospitals</option>` + hosps.map(h => `<option>${h}</option>`).join('');
    }

    // --- PDF ENGINE ---
    function generateReceipt(id) {
        const c = db.find(x => x.id === id);
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Header
        doc.setFontSize(22);
        doc.setTextColor(30, 64, 175);
        doc.setFont("helvetica", "bold");
        doc.text("RECEIPT / BILL", 105, 20, {align: 'center'});

        doc.setLineWidth(0.5);
        doc.setDrawColor(200, 200, 200);
        doc.line(20, 25, 190, 25);

        // Doctor Info
        doc.setFontSize(14);
        doc.setTextColor(0,0,0);
        doc.text(`Dr. ${profile.name.toUpperCase()}`, 20, 35);
        doc.setFontSize(10);
        doc.setTextColor(100,100,100);
        doc.setFont("helvetica", "normal");
        doc.text(profile.degree, 20, 40);
        doc.text(`Reg No: ${profile.reg}`, 20, 45);

        // Date & ID
        doc.text(`Date: ${c.date}`, 150, 35);
        doc.text(`Receipt #: ${c.id.toString().slice(-6)}`, 150, 40);

        // Patient Table
        doc.autoTable({
            startY: 55,
            head: [['Patient Details', 'Surgical Details']],
            body: [
                [
                    `Name: ${c.name}\nAge/Sex: ${c.age} / ${c.sex}\nIPD: ${c.ipd || 'N/A'}`,
                    `Surgery: ${c.surgery}\nSurgeon: Dr. ${c.surgeon}\nHospital: ${c.hosp}\nAnaesthesia: ${c.ana}`
                ]
            ],
            theme: 'grid',
            headStyles: { fillColor: [30, 64, 175] },
            styles: { fontSize: 11, cellPadding: 6 }
        });

        // Fees
        doc.autoTable({
            startY: doc.lastAutoTable.finalY + 10,
            body: [
                ['Professional Anaesthesia Charges', `INR ${c.fee}`],
                ['Payment Mode', `${c.mop} ${c.utr ? '('+c.utr+')' : ''}`]
            ],
            theme: 'plain',
            styles: { fontSize: 10, fontStyle: 'bold', cellPadding: 1.5 },
            columnStyles: { 0: { cellWidth: 40, textColor: [100, 100, 100] } }
        });

        const finalY = doc.lastAutoTable.finalY + 10;
        
        // Total Box
        doc.setFillColor(241, 245, 249);
        doc.rect(10, finalY, 128, 15, 'F');
        doc.setFontSize(11);
        doc.setTextColor(0,0,0);
        doc.setFont("helvetica", "bold");
        doc.text(`RECEIVED: INR ${c.fee}/-`, 15, finalY + 7);
        doc.setFontSize(9);
        doc.setFont("helvetica", "italic");
        doc.text(`(${numToWords(c.fee)})`, 15, finalY + 12);

        // Footer
        doc.setFontSize(9);
        doc.setFont("helvetica", "normal");
        doc.setTextColor(100,100,100);
        doc.text("Thank you for your visit. Get well soon!", 105, finalY + 25, {align: 'center'});
        
        doc.setFontSize(7);
        doc.setTextColor(150,150,150);
        doc.text(`Disclaimer: This receipt acknowledges payment strictly for professional Anaesthesia services\nrendered by the undersigned Anaesthetist at ${c.hosp}.`, 105, finalY + 32, {align: 'center'});

        // QR Code Generation
        const qrStage = document.getElementById("qr_hidden");
        qrStage.innerHTML = "";
        new QRCode(qrStage, { text: `CASE-${c.id}-INR-${c.fee}`, width: 100, height: 100 });
        
        setTimeout(() => {
            const qrImg = qrStage.querySelector("img").src;
            doc.addImage(qrImg, 'PNG', 160, finalY - 5, 25, 25);
            doc.save(`${c.name}_Receipt.pdf`);
        }, 500);
    }

    function exportFullSummary(mode) {
        if(mode === 'whatsapp') {
            const text = `*Anaesthesia Summary Report*\nDoctor: ${profile.name}\nTotal Cases: ${db.length}\nTotal Revenue: ‚Çπ${db.reduce((s,c)=>s+c.fee,0)}\n\nGenerated via AnaesPro`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');
        
        doc.setFontSize(18);
        doc.text(`${profile.name} - Anaesthesia Logbook`, 14, 15);
        doc.setFontSize(10);
        doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 22);

        doc.autoTable({
            startY: 25,
            head: [['Date', 'Patient', 'Surgery', 'Surgeon', 'Hospital', 'Fee']],
            body: db.map(c => [c.date, c.name, c.surgery, c.surgeon, c.hosp, c.fee]),
            theme: 'striped',
            headStyles: { fillColor: [15, 23, 42] }
        });
        
        doc.save('Full_Logbook.pdf');
    }

    // --- DATA UTILS ---
    function backupData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "anaes_backup_" + new Date().toISOString().slice(0,10) + ".json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
        
        profile.lastBackup = Date.now();
        localStorage.setItem('anaes_v5_prof', JSON.stringify(profile));
        checkBackupHealth();
    }

    function restoreData(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const imported = JSON.parse(e.target.result);
                if(Array.isArray(imported)) {
                    if(confirm(`Found ${imported.length} records. Overwrite current data?`)) {
                        db = imported;
                        localStorage.setItem('anaes_v5_db', JSON.stringify(db));
                        location.reload();
                    }
                } else {
                    alert("Invalid backup file format");
                }
            } catch(err) { alert("Error reading file"); }
        };
        reader.readAsText(file);
    }

    function checkBackupHealth() {
        const warning = document.getElementById('backup_warning');
        const days = (Date.now() - (profile.lastBackup || 0)) / (1000 * 60 * 60 * 24);
        if(days > 7 && db.length > 5) {
            warning.classList.remove('hidden');
        } else {
            warning.classList.add('hidden');
        }
    }

    async function exportToExcel() {
        const query = document.getElementById('search_bar').value.toLowerCase();
        const fHosp = document.getElementById('filter_hosp').value;
        let filtered = db;

        if (query) {
            filtered = filtered.filter(c => 
                c.name.toLowerCase().includes(query) || 
                c.surgery.toLowerCase().includes(query) ||
                c.surgeon.toLowerCase().includes(query)
            );
        }
        
        if (fHosp !== 'All') {
            filtered = filtered.filter(c => c.hosp === fHosp);
        }

        const headers = ["Date", "Patient Name", "Age", "Sex", "Surgery", "Anaesthesia", "Surgeon", "Hospital", "Payment Mode", "UTR", "Fees"];
        const rows = filtered.map(c => [`"${c.date}"`, `"${c.name}"`, `"${c.age}"`, `"${c.sex}"`, `"${c.surgery}"`, `"${c.ana}"`, `"Dr. ${c.surgeon}"`, `"${c.hosp}"`, `"${c.mop || 'Cash'}"`, `"${c.utr || ''}"`, `"${c.fee}"`]);
        
        const csvContent = [headers.join(","), ...rows.map(e => e.join(","))].join("\n");
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const file = new File([blob], `Summary.csv`, { type: "text/csv" });
        
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
                await navigator.share({
                    files: [file],
                    title: 'Export Data',
                    text: 'Here is the requested CSV data.'
                });
            } catch (error) {
                console.log('Error sharing:', error);
                downloadFile(blob); 
            }
        } else {
            downloadFile(blob);
        }
    }

    function downloadFile(blob) {
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "Summary.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function showToast(msg) {
        const t = document.getElementById("toast");
        t.innerText = msg;
        t.className = "show";
        setTimeout(() => t.className = t.className.replace("show", ""), 3000);
    }

    function numToWords(n) {
        if (!n || n === 0) return "Zero Only";
        const a = ['','One ','Two ','Three ','Four ', 'Five ','Six ','Seven ','Eight ','Nine ','Ten ','Eleven ','Twelve ','Thirteen ','Fourteen ','Fifteen ','Sixteen ','Seventeen ','Eighteen ','Nineteen '];
        const b = ['', '', 'Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety'];

        const num = ('000000000' + n).slice(-9);
        const match = ('000000000' + n).slice(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
        if (!match) return;

        let str = '';
        str += (Number(match[1]) !== 0) ? (a[Number(match[1])] || b[match[1][0]] + ' ' + a[match[1][1]]) + 'Crore ' : '';
        str += (Number(match[2]) !== 0) ? (a[Number(match[2])] || b[match[2][0]] + ' ' + a[match[2][1]]) + 'Lakh ' : '';
        str += (Number(match[3]) !== 0) ? (a[Number(match[3])] || b[match[3][0]] + ' ' + a[match[3][1]]) + 'Thousand ' : '';
        str += (Number(match[4]) !== 0) ? (a[Number(match[4])] || b[match[4][0]] + ' ' + a[match[4][1]]) + 'Hundred ' : '';
        str += (Number(match[5]) !== 0) ? ((str !== '') ? 'and ' : '') + (a[Number(match[5])] || b[match[5][0]] + ' ' + a[match[5][1]]) : '';

        return str + ' Only';
    }
</script>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('Service Worker registered successfully!', reg))
                .catch(err => console.log('Service Worker registration failed:', err));
        });
    }
</script>

</body>
</html>
