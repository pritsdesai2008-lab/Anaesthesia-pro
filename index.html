<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anaesthesia Suite Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { darkbg: '#0f172a', darkcard: '#1e293b' } } }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid #e2e8f0; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .dark .glass { background: rgba(30, 41, 59, 0.95); border-color: #334155; color: #e2e8f0; }
        
        input, select, textarea { border: 1px solid #cbd5e1; border-radius: 10px; padding: 12px; width: 100%; transition: 0.2s; font-size: 14px; background: white; color: #0f172a; }
        .dark input, .dark select, .dark textarea { background: #0f172a; border-color: #334155; color: white; }
        input:focus { border-color: #3b82f6; outline: none; ring: 2px solid rgba(59, 130, 246, 0.5); }
        
        label { font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 6px; display: block; letter-spacing: 0.8px; }
        .dark label { color: #94a3b8; }
        
        .view { display: none; opacity: 0; transform: translateY(10px); transition: opacity 0.3s, transform 0.3s; }
        .view.active { display: block; opacity: 1; transform: translateY(0); }
        
        .pill { cursor: pointer; padding: 8px 16px; border-radius: 99px; font-size: 11px; font-weight: 700; border: 1px solid #e2e8f0; background: white; transition: 0.2s; color: #64748b; }
        .dark .pill { background: #0f172a; border-color: #334155; color: #94a3b8; }
        .pill.active { background: #3b82f6; color: white; border-color: #3b82f6; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .dark .card-hover:hover { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5); }

        .bar-container { display: flex; align-items: flex-end; justify-content: space-around; height: 160px; padding-top: 20px; }
        .bar { width: 12%; background: linear-gradient(to top, #3b82f6, #60a5fa); border-radius: 6px 6px 0 0; position: relative; transition: height 1s cubic-bezier(0.4, 0, 0.2, 1); }
        .bar span { position: absolute; top: -22px; left: 50%; transform: translateX(-50%); font-size: 10px; font-weight: bold; color: #475569; }
        .dark .bar span { color: #cbd5e1; }
        .bar label { position: absolute; bottom: -28px; left: 50%; transform: translateX(-50%); font-size: 10px; width: 120%; text-align: center; color: #64748b; }

        #toast { visibility: hidden; min-width: 250px; background-color: #0f172a; color: #fff; text-align: center; border-radius: 12px; padding: 16px; position: fixed; z-index: 9999; left: 50%; bottom: 30px; transform: translateX(-50%); font-weight: 700; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        #toast.show { visibility: visible; animation: fadeinout 2.5s; }
        
        .wa-btn { background: #25D366; color: white; }
        .wa-btn:hover { background: #128C7E; }

        @keyframes fadeinout { 0% { bottom: 0; opacity: 0; } 20% { bottom: 30px; opacity: 1; } 80% { bottom: 30px; opacity: 1; } 100% { bottom: 0; opacity: 0; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 transition-colors duration-300">

<div id="toast">Action Confirmed</div>

<div id="app" class="max-w-7xl mx-auto min-h-screen flex flex-col md:flex-row">
    
    <nav class="w-full md:w-72 bg-gradient-to-b from-slate-900 to-slate-950 text-white p-6 flex flex-col sticky top-0 md:h-screen z-[100] shadow-2xl">
        <div class="flex justify-between items-start mb-2 md:mb-10">
            <div>
                <h1 class="text-2xl md:text-3xl font-black tracking-tighter italic text-blue-400">ANAESPRO</h1>
                <p id="nav_dr_name" class="text-[10px] text-slate-400 font-bold mt-1 uppercase tracking-widest">Loading...</p>
            </div>
            <button onclick="toggleNav()" class="md:hidden p-2 text-slate-400 hover:text-white border border-slate-700 rounded-lg">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
        </div>

        <div id="nav_content" class="hidden md:flex flex-col flex-grow space-y-3">
            <button onclick="changeView('dashboard')" class="w-full text-left p-4 rounded-xl hover:bg-white/5 transition font-bold text-sm border border-transparent hover:border-slate-700/50 flex items-center gap-3"><span>üìä</span> Dashboard</button>
            <button onclick="changeView('new-case')" class="w-full text-left p-4 rounded-xl hover:bg-white/5 transition font-bold text-sm border border-transparent hover:border-slate-700/50 flex items-center gap-3"><span>‚úö</span> New Case</button>
            <button onclick="changeView('logbook')" class="w-full text-left p-4 rounded-xl hover:bg-white/5 transition font-bold text-sm border border-transparent hover:border-slate-700/50 flex items-center gap-3"><span>üìã</span> Logbook</button>
            <button onclick="toggleProfile()" class="w-full text-left p-4 rounded-xl border border-slate-700 hover:bg-white/5 transition font-bold text-sm mt-8 flex items-center gap-3"><span>‚öô</span> Settings & Data</button>
            
            <div class="pt-6 border-t border-slate-800 mt-auto space-y-3">
                <button onclick="toggleTheme()" class="w-full bg-slate-800 hover:bg-slate-700 p-3 rounded-xl text-xs font-bold flex items-center justify-center gap-2"><span id="theme_icon">üåë</span> Toggle OT Mode</button>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="exportFullSummary()" class="bg-blue-600 hover:bg-blue-500 p-3 rounded-xl text-[10px] font-black uppercase shadow-lg transition">Summary PDF</button>
                    <button onclick="exportToExcel()" class="bg-emerald-600 hover:bg-emerald-500 p-3 rounded-xl text-[10px] font-black uppercase shadow-lg transition">Excel Export</button>
                </div>
                <p class="text-[9px] text-slate-500 text-center mt-2">v5.2 Patched for AppsGeyser</p>
            </div>
        </div>
    </nav>

    <main class="flex-grow p-4 md:p-10 pb-24 bg-slate-50 dark:bg-darkbg relative z-10 transition-colors duration-300">
        
        <div id="view-dashboard" class="view active">
            <div class="mb-8">
                <h2 class="text-3xl font-black text-slate-900 dark:text-white tracking-tight">Practice Overview</h2>
                <p class="text-xs text-slate-500 dark:text-slate-400 font-bold uppercase tracking-widest mt-1">Real-time Financial Insights</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="glass card-hover p-6 rounded-2xl border-l-8 border-blue-500">
                    <p class="text-[10px] text-slate-400 font-bold uppercase">Total Revenue (All Time)</p>
                    <p id="dash_total" class="text-3xl font-black text-slate-800 dark:text-white">‚Çπ0</p>
                </div>
                <div class="glass card-hover p-6 rounded-2xl border-l-8 border-emerald-500">
                    <p class="text-[10px] text-slate-400 font-bold uppercase">Revenue This Month</p>
                    <p id="dash_month" class="text-3xl font-black text-slate-800 dark:text-white">‚Çπ0</p>
                </div>
                <div class="glass card-hover p-6 rounded-2xl border-l-8 border-purple-500">
                    <p class="text-[10px] text-slate-400 font-bold uppercase">Total Cases</p>
                    <p id="dash_cases" class="text-3xl font-black text-slate-800 dark:text-white">0</p>
                </div>
            </div>

            <div class="glass p-6 rounded-3xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-black text-slate-700 dark:text-slate-300 uppercase">Revenue Trend (6 Months)</h3>
                </div>
                <div id="chart_container" class="bar-container border-b border-slate-200 dark:border-slate-700"></div>
            </div>

            <div class="mt-8 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 p-4 rounded-xl hidden" id="backup_warning">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">‚ö†Ô∏è</span>
                    <div>
                        <h4 class="font-bold text-yellow-800 dark:text-yellow-500 text-sm">Data Backup Recommended</h4>
                        <p class="text-[10px] text-yellow-700 dark:text-yellow-600">It's been over 7 days since your last backup.</p>
                    </div>
                    <button onclick="toggleProfile()" class="ml-auto bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 px-3 py-1 rounded-lg text-xs font-bold">Backup</button>
                </div>
            </div>
        </div>

        <div id="profile_view" class="hidden mb-10 glass p-6 md:p-8 rounded-3xl shadow-xl border-2 border-blue-500/20">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black uppercase text-slate-800 dark:text-white">Settings & Data</h2>
                <button onclick="toggleProfile()" class="text-slate-400 text-2xl hover:text-red-500">&times;</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <label class="text-blue-600 dark:text-blue-400 font-black">Identity</label>
                    <div><label>Your Name</label><input type="text" id="cfg_name"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label>Qualification</label><input type="text" id="cfg_degree"></div>
                        <div><label>Reg Number</label><input type="text" id="cfg_reg"></div>
                    </div>
                    <div><label>Hospital Header</label><textarea id="cfg_hosp" rows="2"></textarea></div>
                    <button onclick="saveProfile()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black text-sm uppercase hover:bg-blue-700 transition mt-2">Save Settings</button>
                </div>
                <div class="space-y-4 bg-slate-50 dark:bg-darkcard p-6 rounded-2xl">
                    <label class="text-red-600 font-black">Data Management</label>
                    <button onclick="backupData()" class="w-full bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 py-3 rounded-lg font-bold text-xs uppercase mb-2 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200">üì• Download JSON Backup</button>
                    <input type="file" id="import_file" class="hidden" onchange="importData(event)">
                    <button onclick="document.getElementById('import_file').click()" class="w-full bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 py-3 rounded-lg font-bold text-xs uppercase hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200">üì§ Restore from File</button>
                </div>
            </div>
        </div>

        <div id="view-new-case" class="view max-w-5xl mx-auto">
            <div class="mb-4 md:mb-8">
                <h2 class="text-2xl md:text-4xl font-black text-slate-900 dark:text-white tracking-tight">New Clinical Entry</h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8">
                <div class="glass p-5 md:p-8 rounded-3xl space-y-4 md:space-y-5 shadow-sm">
                    <h3 class="text-xs font-black text-blue-600 dark:text-blue-400 border-b dark:border-slate-700 pb-2 uppercase tracking-widest">Patient Registry</h3>
                    <div><label>Patient Full Name</label><input type="text" id="in_name" class="font-bold text-lg"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label>Age</label><input type="number" id="in_age"></div>
                        <div><label>Sex</label><select id="in_sex"><option>Male</option><option>Female</option><option>Other</option></select></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label>IPD / Case No</label><input type="text" id="in_ipd"></div>
                        <div><label>Procedure Date</label><input type="date" id="in_date"></div>
                    </div>
                </div>
                <div class="glass p-5 md:p-8 rounded-3xl space-y-4 md:space-y-5 shadow-sm">
                    <h3 class="text-xs font-black text-blue-600 dark:text-blue-400 border-b dark:border-slate-700 pb-2 uppercase tracking-widest">Surgical Details</h3>
                    <div><label>Surgery Performed</label><input type="text" id="in_surgery" list="dl_surgery"></div>
                    <div><label>Lead Surgeon</label><input type="text" id="in_surgeon" list="dl_surgeon"></div>
                    <div><label>Anaesthesia Type</label><input type="text" id="in_ana" list="dl_ana"></div>
                    <div><label>Hospital / Facility</label><input type="text" id="in_hosp" list="dl_hosp"></div>
                </div>
            </div>
            <div class="mt-4 md:mt-8 glass p-6 md:p-10 rounded-[2rem] border-2 border-slate-900 dark:border-blue-500/50 shadow-2xl">
                <div class="text-center mb-6">
                    <label class="text-slate-400 font-bold mb-2">Professional Fees (INR)</label>
                    <div class="flex justify-center items-center gap-3">
                        <span class="text-3xl md:text-5xl font-light text-slate-300 dark:text-slate-600">‚Çπ</span>
                        <input type="number" id="in_fee" class="text-5xl md:text-7xl font-black text-slate-900 dark:text-white bg-transparent border-none text-center focus:ring-0 p-0 w-full" placeholder="0">
                    </div>
                </div>
                <div class="bg-slate-50 dark:bg-darkcard p-6 rounded-2xl border border-slate-200 dark:border-slate-700">
                    <label class="text-blue-600 dark:text-blue-400 mb-2">Payment Mode & Details</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <select id="in_mop">
                            <option value="Cash">Cash</option>
                            <option value="UPI / Online">UPI / Online</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Cheque">Cheque</option>
                        </select>
                        <input type="text" id="in_utr" placeholder="UTR / Ref No. (Optional)">
                    </div>
                </div>
            </div>
            <button onclick="saveCaseRecord()" class="w-full mt-6 md:mt-8 bg-blue-600 hover:bg-blue-700 text-white py-5 md:py-6 rounded-2xl font-black text-lg md:text-xl shadow-xl transition transform active:scale-95">COMMIT CLINICAL RECORD</button>
        </div>

        <div id="view-logbook" class="view">
            <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
                <div>
                    <h2 class="text-3xl md:text-4xl font-black text-slate-900 dark:text-white uppercase tracking-tighter">Logbook</h2>
                </div>
                <div class="text-right glass p-6 rounded-2xl border-l-8 border-green-500 w-full md:w-auto">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Revenue Audit</p>
                    <p id="total_display" class="text-4xl font-black text-slate-900 dark:text-white">‚Çπ0</p>
                </div>
            </div>
            
            <div class="glass p-4 rounded-3xl mb-8 space-y-4">
                <div class="flex flex-wrap gap-2">
                    <button class="pill active whitespace-nowrap" data-f="all">All Time</button>
                    <button class="pill whitespace-nowrap" data-f="daily">Today</button>
                    <button class="pill whitespace-nowrap" data-f="weekly">Week</button>
                    <button class="pill whitespace-nowrap" data-f="monthly">Month</button>
                </div>
                <div class="flex flex-col md:flex-row gap-3">
                    <input type="text" id="search_bar" oninput="renderLog()" placeholder="Search Name..." class="flex-grow">
                    <select id="filter_hosp" onchange="renderLog()" class="md:w-1/4"><option value="">All Hospitals</option></select>
                    <select id="filter_surgeon" onchange="renderLog()" class="md:w-1/4"><option value="">All Surgeons</option></select>
                </div>
            </div>

            <div id="log_container" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
        </div>
    </main>

    <datalist id="dl_surgery"></datalist><datalist id="dl_surgeon"></datalist><datalist id="dl_hosp"></datalist>
    <datalist id="dl_ana"><option value="Spinal Anaesthesia"><option value="General Anaesthesia (GA)"><option value="Epidural Anaesthesia"><option value="MAC / Sedation"></datalist>
    <div id="qr_hidden" class="hidden"></div>
</div>

<script>
    // --- 1. DATA & INIT ---
    let db = JSON.parse(localStorage.getItem('anaes_v5_db')) || [];
    let profile = JSON.parse(localStorage.getItem('anaes_v5_prof')) || { 
        name: 'Doctor Name', degree: 'Degree', reg: 'Reg No', hosp: 'Hospital Name',
        lastBackup: 0, theme: 'light'
    };
    let editId = null;
    let timeFilter = 'all';

    function initUI() {
        if(profile.theme === 'dark') document.documentElement.classList.add('dark');
        updateThemeIcon();

        // Load Profile
        document.getElementById('cfg_name').value = profile.name;
        document.getElementById('cfg_degree').value = profile.degree;
        document.getElementById('cfg_reg').value = profile.reg;
        document.getElementById('cfg_hosp').value = profile.hosp;
        document.getElementById('nav_dr_name').innerText = `Dr. ${profile.name.toUpperCase()}`;
        document.getElementById('in_date').valueAsDate = new Date();
        
        updateDatalists(); checkBackupHealth(); updateDashboard(); setupSmartFilters();
        
        document.querySelectorAll('.pill').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
                btn.classList.add('active');
                timeFilter = btn.dataset.f;
                renderLog();
            });
        });
    }

    // --- 2. THEME & NAVIGATION ---
    function toggleTheme() {
        const isDark = document.documentElement.classList.toggle('dark');
        profile.theme = isDark ? 'dark' : 'light';
        localStorage.setItem('anaes_v5_prof', JSON.stringify(profile));
        updateThemeIcon();
    }
    function updateThemeIcon() { document.getElementById('theme_icon').innerText = profile.theme === 'dark' ? '‚òÄ' : 'üåë'; }
    function toggleNav() { document.getElementById('nav_content').classList.toggle('hidden'); }
    function showToast(msg) { const t = document.getElementById("toast"); t.innerText = msg; t.className = "show"; setTimeout(() => { t.className = t.className.replace("show", ""); }, 2500); }
    function toggleProfile() { document.getElementById('profile_view').classList.toggle('hidden'); if(window.innerWidth < 768) document.getElementById('nav_content').classList.add('hidden'); }
    function changeView(v) {
        document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
        document.getElementById(`view-${v}`).classList.add('active');
        if(v === 'logbook') renderLog();
        if(v === 'dashboard') updateDashboard();
        if(window.innerWidth < 768) document.getElementById('nav_content').classList.add('hidden');
    }

    // --- 3. CORE LOGIC (Save/Edit/Delete) ---
    function saveProfile() {
        profile.name = document.getElementById('cfg_name').value.replace(/^Dr\.\s*/i, "");
        profile.degree = document.getElementById('cfg_degree').value;
        profile.reg = document.getElementById('cfg_reg').value;
        profile.hosp = document.getElementById('cfg_hosp').value;
        localStorage.setItem('anaes_v5_prof', JSON.stringify(profile));
        document.getElementById('nav_dr_name').innerText = `Dr. ${profile.name.toUpperCase()}`;
        toggleProfile(); showToast("Profile Updated");
    }

    function saveCaseRecord() {
        const nameVal = document.getElementById('in_name').value;
        if(!nameVal) { showToast("Name Required"); return; }
        const data = {
            id: editId || Date.now(),
            name: nameVal.toUpperCase(),
            age: document.getElementById('in_age').value,
            sex: document.getElementById('in_sex').value,
            ipd: document.getElementById('in_ipd').value,
            date: document.getElementById('in_date').value,
            surgery: document.getElementById('in_surgery').value,
            surgeon: document.getElementById('in_surgeon').value.replace(/^Dr\.\s*/i, ""),
            ana: document.getElementById('in_ana').value,
            hosp: document.getElementById('in_hosp').value,
            fee: parseFloat(document.getElementById('in_fee').value || 0),
            mop: document.getElementById('in_mop').value,
            utr: document.getElementById('in_utr').value
        };
        if(editId) { const idx = db.findIndex(x => x.id === editId); db[idx] = data; editId = null; } else { db.push(data); }
        localStorage.setItem('anaes_v5_db', JSON.stringify(db));
        resetForm(); updateDatalists(); changeView('logbook'); showToast("Record Committed");
    }

    function renderLog() {
        const query = document.getElementById('search_bar').value.toLowerCase();
        const fHosp = document.getElementById('filter_hosp').value;
        const fSurg = document.getElementById('filter_surgeon').value;
        const now = new Date();
        const filtered = db.filter(c => {
            const matchesQuery = c.name.toLowerCase().includes(query) || c.hosp.toLowerCase().includes(query) || c.surgeon.toLowerCase().includes(query);
            if(!matchesQuery) return false;
            if(fHosp && c.hosp !== fHosp) return false;
            if(fSurg && c.surgeon !== fSurg) return false;
            const cDate = new Date(c.date);
            if(timeFilter === 'daily') return c.date === now.toISOString().split('T')[0];
            if(timeFilter === 'weekly') return ((now - cDate) / 86400000) <= 7;
            if(timeFilter === 'monthly') return cDate.getMonth() === now.getMonth() && cDate.getFullYear() === now.getFullYear();
            return true;
        });

        document.getElementById('total_display').innerText = `‚Çπ${filtered.reduce((s,c) => s + c.fee, 0)}`;
        document.getElementById('log_container').innerHTML = filtered.sort((a,b) => b.id - a.id).map(c => `
            <div class="glass card-hover p-6 rounded-3xl border-l-8 border-blue-600 shadow-sm relative">
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="font-black text-slate-800 dark:text-slate-100 text-lg tracking-tight">${c.name}</h4>
                        <p class="text-[10px] text-blue-600 dark:text-blue-400 font-black uppercase tracking-widest mt-1">${c.date} ‚Ä¢ ${c.surgery}</p>
                    </div>
                    <p class="text-2xl font-black text-slate-900 dark:text-white">‚Çπ${c.fee}</p>
                </div>
                <div class="grid grid-cols-2 gap-2 mt-4">
                    <div class="bg-slate-50 dark:bg-slate-800 p-2 rounded-lg text-[9px] font-bold text-slate-500 dark:text-slate-400 uppercase truncate">Dr. ${c.surgeon}</div>
                    <div class="bg-slate-50 dark:bg-slate-800 p-2 rounded-lg text-[9px] font-bold text-slate-500 dark:text-slate-400 uppercase truncate">${c.hosp}</div>
                </div>
                <div class="flex gap-2 mt-4">
                    <button onclick="editCase(${c.id})" class="flex-1 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 dark:text-slate-300 text-[9px] font-black uppercase">Edit</button>
                    <button onclick="deleteCase(${c.id})" class="flex-1 py-2 rounded-xl bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-300 text-[9px] font-black uppercase">Del</button>
                    <button onclick="generateReceiptPDF(${c.id})" class="flex-[1.5] py-2 rounded-xl bg-slate-900 dark:bg-blue-600 text-white text-[9px] font-black uppercase shadow-lg">Receipt</button>
                </div>
            </div>
        `).join('');
    }

    // --- 4. PRINTING (THE APPSGEYSER FIX) ---
    // 100% RELIABLE: Generates HTML Blob -> Opens in Chrome -> Save as PDF
    
    function openInSystemBrowser(htmlContent) {
        const blob = new Blob([htmlContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.target = "_blank"; // Forces Android System Browser
        a.click();
    }

    function generateReceiptPDF(id) {
        showToast("Opening Receipt...");
        const c = db.find(x => x.id === id);
        
        // Generate QR Code
        const qrDiv = document.getElementById("qr_hidden");
        qrDiv.innerHTML = "";
        new QRCode(qrDiv, { text: `CASE:${c.id}|AMT:${c.fee}`, width: 80, height: 80 });
        const qrUrl = qrDiv.querySelector('canvas').toDataURL();

        const html = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Receipt-${c.name}</title>
                <style>
                    body { font-family: sans-serif; padding: 30px; color: #333; max-width: 800px; margin: auto; }
                    .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
                    .hosp-name { font-size: 24px; font-weight: bold; text-transform: uppercase; }
                    .meta { display: flex; justify-content: space-between; margin-bottom: 30px; font-size: 14px; }
                    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; border: 1px solid #ddd; padding: 20px; border-radius: 8px; }
                    .label { font-size: 10px; text-transform: uppercase; color: #777; font-weight: bold; }
                    .val { font-size: 16px; font-weight: bold; }
                    .total { margin-top: 30px; text-align: right; background: #f8f9fa; padding: 20px; font-size: 20px; font-weight: bold; border-radius: 8px; }
                    .footer { margin-top: 50px; text-align: center; font-size: 12px; color: #777; border-top: 1px solid #eee; padding-top: 20px; }
                    .print-btn { position: fixed; bottom: 20px; right: 20px; background: #2563eb; color: white; padding: 15px 30px; border: none; border-radius: 50px; font-size: 16px; cursor: pointer; box-shadow: 0 4px 12px rgba(37,99,235,0.4); text-decoration: none; }
                    @media print { .print-btn { display: none; } }
                </style>
            </head>
            <body>
                <div class="header">
                    <div class="hosp-name">${profile.hosp}</div>
                    <div style="font-size:12px; margin-top:5px;">Professional Anaesthesia Services</div>
                </div>
                
                <div class="meta">
                    <div><strong>Receipt #:</strong> ${c.id}</div>
                    <div><strong>Date:</strong> ${c.date}</div>
                </div>

                <div class="grid">
                    <div><div class="label">Patient Name</div><div class="val">${c.name}</div></div>
                    <div><div class="label">Age / Sex</div><div class="val">${c.age} / ${c.sex}</div></div>
                    <div><div class="label">Surgery</div><div class="val">${c.surgery}</div></div>
                    <div><div class="label">Hospital</div><div class="val">${c.hosp}</div></div>
                    <div><div class="label">Surgeon</div><div class="val">Dr. ${c.surgeon}</div></div>
                    <div><div class="label">Anaesthesia</div><div class="val">${c.ana}</div></div>
                </div>

                <div class="total">
                    RECEIVED: ‚Çπ${c.fee}/-<br>
                    <span style="font-size:12px; font-weight:normal; color:#555;">(${c.mop})</span>
                </div>

                <div class="footer">
                    <img src="${qrUrl}" width="80" style="margin-bottom:10px;"><br>
                    <strong>Dr. ${profile.name}</strong><br>${profile.degree} | Reg: ${profile.reg}
                    <p>Get Well Soon!</p>
                </div>

                <a href="#" onclick="window.print()" class="print-btn">üñ®Ô∏è Print / Save as PDF</a>
            </body>
            </html>
        `;
        openInSystemBrowser(html);
    }

    function exportFullSummary() {
        showToast("Generating Summary...");
        const filtered = getFilteredData();
        const total = filtered.reduce((s,c) => s + c.fee, 0);

        const html = `
            <html>
            <head>
                <title>Summary Report</title>
                <style>
                    body{font-family:sans-serif;padding:20px;} 
                    h2 { text-align: center; color: #333; margin-bottom: 5px; }
                    p { text-align: center; color: #666; margin-top: 0; font-size: 12px; }
                    table{width:100%;border-collapse:collapse; margin-top: 20px;} 
                    th,td{border:1px solid #333;padding:8px; font-size: 12px;} 
                    th{background:#0f172a; color: white; text-align: left;} 
                    tr:nth-child(even) {background-color: #f2f2f2;}
                    .total { text-align: right; font-weight: bold; background: #eee; }
                    .btn{position: fixed; bottom: 20px; right: 20px; background:blue; color:white; padding:15px; border-radius:50px; text-decoration:none; box-shadow: 0 5px 15px rgba(0,0,0,0.2);}
                    @media print { .btn { display: none; } }
                </style>
            </head>
            <body>
                <h2>CLINICAL LOGBOOK SUMMARY</h2>
                <p>Period: ${timeFilter.toUpperCase()} | Generated: ${new Date().toLocaleDateString()}</p>
                <table>
                    <thead><tr><th>Date</th><th>Patient</th><th>Surgery</th><th>Surgeon</th><th>Hospital</th><th style="text-align:right">Fee</th></tr></thead>
                    <tbody>
                        ${filtered.map(c => `<tr><td>${c.date}</td><td>${c.name}</td><td>${c.surgery}</td><td>Dr. ${c.surgeon}</td><td>${c.hosp}</td><td style="text-align:right">‚Çπ${c.fee}</td></tr>`).join('')}
                    </tbody>
                    <tfoot>
                        <tr><td colspan="5" class="total">TOTAL REVENUE</td><td class="total">‚Çπ${total}</td></tr>
                    </tfoot>
                </table>
                <a href="#" onclick="window.print()" class="btn">üñ®Ô∏è Print / Save as PDF</a>
            </body>
            </html>
        `;
        openInSystemBrowser(html);
    }

    // --- 5. UTILS & EXCEL ---
    function getFilteredData() {
        const now = new Date();
        return db.filter(c => {
            if(timeFilter === 'daily') return c.date === now.toISOString().split('T')[0];
            if(timeFilter === 'weekly') return ((now - new Date(c.date)) / 86400000) <= 7;
            if(timeFilter === 'monthly') return new Date(c.date).getMonth() === now.getMonth();
            return true;
        });
    }

    function exportToExcel() {
        const filtered = getFilteredData();
        const csv = ["Date,Patient,Surgery,Hospital,Fee"].concat(filtered.map(c => `${c.date},"${c.name}",${c.surgery},${c.hosp},${c.fee}`)).join("\n");
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = 'Summary.csv'; a.click();
    }
    
    // Standard Helpers
    function updateDashboard() {
        const total = db.reduce((s,c) => s + c.fee, 0);
        document.getElementById('dash_total').innerText = '‚Çπ' + total.toLocaleString();
        document.getElementById('dash_cases').innerText = db.length;
        const now = new Date();
        const thisMonth = db.filter(c => new Date(c.date).getMonth() === now.getMonth()).reduce((s,c) => s + c.fee, 0);
        document.getElementById('dash_month').innerText = '‚Çπ' + thisMonth.toLocaleString();
    }
    function updateDatalists() { const fill = (id, key) => { const list = [...new Set(db.map(x => x[key]))].filter(x => x); document.getElementById(id).innerHTML = list.map(v => `<option value="${v}">`).join(''); }; fill('dl_surgery', 'surgery'); fill('dl_surgeon', 'surgeon'); fill('dl_hosp', 'hosp'); }
    function setupSmartFilters() { document.getElementById('filter_hosp').innerHTML = '<option value="">All Hospitals</option>' + [...new Set(db.map(x => x.hosp))].sort().map(h => `<option>${h}</option>`).join(''); document.getElementById('filter_surgeon').innerHTML = '<option value="">All Surgeons</option>' + [...new Set(db.map(x => x.surgeon))].sort().map(s => `<option>${s}</option>`).join(''); }
    function checkBackupHealth() { if((Date.now() - (profile.lastBackup || 0)) > 604800000) document.getElementById('backup_warning').classList.remove('hidden'); }
    function backupData() { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db)); a.download = `anaespro_backup_${Date.now()}.json`; a.click(); profile.lastBackup = Date.now(); localStorage.setItem('anaes_v5_prof', JSON.stringify(profile)); showToast("Backup Saved"); }
    function importData(e) { const r = new FileReader(); r.onload = (ev) => { db = JSON.parse(ev.target.result); localStorage.setItem('anaes_v5_db', JSON.stringify(db)); location.reload(); }; r.readAsText(e.target.files[0]); }
    function deleteCase(id) { if(confirm("Permanently delete?")) { db = db.filter(x => x.id !== id); localStorage.setItem('anaes_v5_db', JSON.stringify(db)); renderLog(); updateDashboard(); } }
    function editCase(id) { const c = db.find(x => x.id === id); editId = id; document.getElementById('in_name').value = c.name; document.getElementById('in_age').value = c.age; document.getElementById('in_sex').value = c.sex; document.getElementById('in_ipd').value = c.ipd; document.getElementById('in_date').value = c.date; document.getElementById('in_surgery').value = c.surgery; document.getElementById('in_surgeon').value = c.surgeon; document.getElementById('in_ana').value = c.ana; document.getElementById('in_hosp').value = c.hosp; document.getElementById('in_fee').value = c.fee; document.getElementById('in_mop').value = c.mop || 'Cash'; document.getElementById('in_utr').value = c.utr || ''; changeView('new-case'); }
    function resetForm() { document.querySelectorAll('#view-new-case input:not([type="date"])').forEach(i => i.value = ''); document.getElementById('in_mop').value = 'Cash'; }

    window.addEventListener('DOMContentLoaded', initUI);
</script>
</body>
</html>
